---
title: "WB plots"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r start, echo=F}
rm(list = ls())
try(setwd("~/Dropbox/Valentino/Projects/WB_plots") , silent = T)
try(setwd("C:/Users/valdes/Dropbox/Valentino/Projects/WB_plots") , silent = T)
try(setwd("Z:/Dropbox/Valentino/Projects/WB_plots") , silent = T)
#setwd("C:/Users/wb388321/Documents/GitHub/Envisage_ESMAP/18x29/Output")


#' directory where to save all plots
#' (can then use file.path(chart_dir, "plot_name.pdg") when saving)
chart_dir <- file.path(getwd(), "charts")

#' load custom ggplot theme
#source("scripts/custom_ggplot.R")

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Load dependencies 

packages <- c("magrittr",
              "tidyverse",
              # "ggeasy",
              # "hrbrthemes",
              "patchwork")
to.install <- setdiff(packages, rownames(installed.packages()))
if (length(to.install) > 0) {
  install.packages(to.install)
}
lapply(packages, library, character.only = TRUE)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Load data

d <- read_csv("data/power.csv")


#' count uniques per column
d %>% 
  select( where(is.character) ) %>% 
  summarise_all(n_distinct)

#' explore values of each column
d_exp <- d %>% 
  select( where(is.character) ) %>% 
  summarise_all( ~ list(table(.)))
lapply(names(d_exp), function(x) d_exp[[x]] %>% data.frame )


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## define groups for filtering


# Separate 5-year data without baseline
gyears1 <- c(2020, 2025, 2030, 2035, 2040)
gyears2 <- c(2030, 2035, 2040)
gyears3 <- c(2020, 2030, 2040)
gyears4 <- c(2020, 2025, 2030)

#' Define scenarios
gsims_bau   <-  c("BaU")
gsims       <-  c("SimAgrPdy1C","SimAgrPdy2C","SimLabPdy1C","SimLabPdy2C",
                  "SimKdamL", "SimKdamH", "SimAll_low","SimAll_high")
gsims_sec   <- c("SimAgrPdy1C","SimAgrPdy2C") #,"SimAgrPdy3C")
gsims_lab   <- c("SimLabPdy1C","SimLabPdy2C")
gsims_Kdam  <- c("SimKdamH", "SimKdamL")
gsims_all   <- c("SimAll_high","SimAll_low")

#' Define regions
list_ctries <- c("CIV","ETH","GHA","KEN","MOZ","NGA","SEN","TZA","ZAF")

#' labels for activity 
#' "E_H-a" "E_C-a" are missing
activity_names <- tribble(  ~levels, ~labels,
                            "E_O-a", "Oil", 
                            "E_G-a", "Gas", 
                            "E_W-a", "Wind", 
                            "E_S-a", "Solar",
                            "E_X-a", "Other" )
```



```{r energy}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Energy structure ----

d_energy <- d %>% 
            filter( Var == "XP",
                    Year %in% gyears4,
                    Region %in% list_ctries,
                    Sim %in% gsims_bau )
 
#' Estimate shares by year-region
d_energy %<>% 
  group_by(Region, Year) %>%
  mutate( total = sum(Value),
          share = Value/total) 

#' update Activity names
#' if some levels are not found then there will be NAs
d_energy %<>% 
  mutate( Activity = factor(Activity,
                            levels = activity_names$levels,
                            labels = activity_names$labels))  


#' create a function that creates the plots
#my.plot <- function(x){
 #debug 
 x = list_ctries[1]
  
  # create title
  ctitle <- paste(x, ": Energy composition in baseline" )
  
  # filter
  d_energy %>% 
    filter(Region == x) %>% 
    ggplot(., aes(x=Year,
                  y=share,
                  fill=Activity)) + 
    geom_col(position=position_dodge(),
             width = 4) +
    ggtitle(title) +
    labs(title = ctitle, 
         subtitle = "Power source shares of total energy generation",
         x = "Year",
         y = "shares",
         fill = "Power source:") + 
    scale_fill_manual(values = c("lightsteelblue1", "lightskyblue", "dodgerblue", "blue", "navy","black" )) +
    scale_y_continuous(limits = c(0, 1), breaks=seq(0,1,0.1), 
                       labels = scales::number_format(accuracy = 0.1)) +
    scale_x_continuous(position = "bottom" , breaks=seq(2020,2030,10)) #+ # reorginize the ticks of x-axis
   # my_theme2
  # save plot
  # ggsave( file.path(chart_dir, paste0("energy_baseline_", x, ".pdf")),
  #         width=10,
  #         height=6) 
#}
```

## Including Plots

The text can contain numbers calculated with the data. Eg the number of rows in the data is `r nrow(d)`

```{r }
#sapply(list_ctries[1], my.plot) 
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
